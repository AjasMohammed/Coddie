services:
    db:
        image: postgres:15
        container_name: challenger_db
        restart: unless-stopped
        environment:
            POSTGRES_DB: challenger
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
        ports:
            - "5435:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data

    redis:
        image: redis:7
        container_name: challenger_redis
        restart: unless-stopped
        ports:
            - "6381:6379"

    piston:
        image: ghcr.io/engineer-man/piston:latest
        container_name: challenger_piston
        restart: unless-stopped

        # Piston wants privileged mode by default (for sandboxing with cgroups)
        privileged: true

        ports:
            - "2000:2000"

        # Persist runtimes (they live in /piston/packages inside the container)
        volumes:
            - ./piston-data/packages:/piston/packages:rw

        # Fast in-memory temp dirs for jobs
        tmpfs:
            - /tmp:exec,size=1G
            - /piston/isolate:exec,size=1G

        environment:
            - PISTON_LOG_LEVEL=INFO
            - PISTON_DISABLE_NETWORKING=true

volumes:
    postgres_data:
